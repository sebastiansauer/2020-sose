---
title: "Wiederholung"
author: "ses"
date: "7/1/2021"
output: 
  html_document:
    toc: TRUE
    number_sections: TRUE
---





# Vorbereitung

## Pakete laden

```{r message=FALSE}
library(tidyverse)
```



## Daten laden

```{r}
data("diamonds")
```



# Aufgaben


## Werte zuweisen


### Problem

a) Definieren Sie eine Variable "alter" mit dem Wert 42
b) Definieren Sie eine Variable "name" mit dem Wert "Schorsch"
c) Definieren Sie eine Variable "schorsch" mit dem Wert "42"


### Lösung




```{r}
alter <- 42  # a
name <- "Schorsch"  # b
schorsch <- "42"  # c
```


```{r}
name <- schorsch
```



## Filtern


### Problem

Laden Sie zunächst die Tabelle "diamonds".



Filtern Sie ...

a) alle Diamanten besten Schliffs.
b) alle Diamanten mit einem Preis zwischen 1000 und 10000 Dollar.
c) alle Diamanten mit bester Farbe und bestem Schliff
d) die 10% teuersten Diamanten.


### Lösung

```{r}
data("diamonds")  # ggplot2, das ist Teil des Tidyverse
```


a)

```{r}
diamonds %>% 
  filter(cut == "Ideal")
```

b)


 alle Diamanten mit einem Preis zwischen 1000 und 10000 Dollar.
 
```{r}
diamonds %>% 
  filter(price >= 1e3 & price <= 1e4)
```


```{r}
diamonds %>% 
  filter(between(price, 1e03, 1e04))
```

 
c) alle Diamanten mit bester Farbe und bestem Schliff


```{r}
diamonds %>% 
  filter(cut == "Ideal", color == "D")
```



d) die 10% teuersten Diamanten

```{r}
diamonds %>% 
  slice_max(order_by = price, prop = .1)
```

```{r}
d2 <- diamonds %>% 
  mutate(price_percent = percent_rank(price)) %>% 
  filter(price_percent > .9)

d2
```



## Zusammenfassen



### Problem

a) Was ist der mittlere Preis der Diamanten?
b) Der mediane?
c) die SD?
d) der IQR?
e) Was lernen wir daraus, wenn es zwischen Median und MW einen Unterschied gibt?
f) Kennen Sie einen Weg, viele Statistiken auf einmal zu bekommen? Welchen?
g) Was ist der mittlere Preis pro Stufe von `cut`?



### Lösung

a) Was ist der mittlere Preis der Diamanten?


```{r}
diamonds %>% 
  drop_na(price) %>% 
  summarise(price_m = mean(price))
```

b) Der mediane?




```{r}
diamonds %>% 
  drop_na(price) %>% 
  summarise(price_md = median(price))
```


c) und d)




```{r}
diamonds %>% 
  drop_na(price) %>% 
  summarise(price_sd = sd(price),
            price_iqr = IQR(price))
```


e) Was lernen wir daraus, wenn es zwischen Median und MW einen Unterschied gibt?

MW - Md ist prop. zur Schiefe (es gibt Extremwerte)



f) Kennen Sie einen Weg, viele Statistiken auf einmal zu bekommen? Welchen?


```{r}
library(skimr)

skim(diamonds)
```



g) Was ist der mittlere Preis pro Stufe von `cut`?



```{r}
diamonds %>% 
  group_by(cut) %>% 
  summarise(price_avg = mean(price))
```






## Sortieren


### Problem 

Sortieren Sie den Datensatz nach Preis und zeigen Sie die Top-3-Diamanten (hinsichtlich der max. Höhe des Preises)!



### Lösung



```{r}
diamonds %>% 
  arrange(-price) %>%   # alternativ: desc(price)
  slice(1:3)
```




```{r}
diamonds %>% 
  slice_max(price, n = 3)
```









## Mutieren

### Problem

a) Erstellen Sie eine Variable, die die *Größenordnung* des Preises angibt: 
  - dreistelliger Preis (100-999) -> Wert ist *2*  -> log10(100) = 2
  - vierstelliger Preis (1000-9999) -> Wert ist *3*
  - etc.
b) Berechnen Sie eine Art "Volumen" des Diamanten, in dem Sie `x`, `y` und `z` multiplizieren.
c) Erstellen Sie eine Variable, die angibt, ob der Preis des Diamanten größer als der Mittelwert ist.
d) Berechnen Sie die Korrelation von Volumen und Gewicht (`carat`).


### Lösung


a)

```{r}
log10(100) == 2
log10(1000) == 3
log10(1e4) == 4  # 10000 = 10^4 
```


:-)

```{r}
diamonds <-
  diamonds %>% 
  mutate(preis_log10 = log10(price))
```

In diesem Fall wäre es nicht so gut mit `case_when` zu arbeiten:

```{r}
diamonds %>% 
  mutate(price_oom = case_when(
    price > 100 & price < 1000 ~ 2,
    price < 10000 ~ 3,
    TRUE ~ NA_real_
  ))
```





b)

```{r}
diamonds <-
  diamonds %>% 
  mutate(volume = x * y * z)
```



c)

```{r}
diamonds <- 
  diamonds %>% 
  mutate(price_high = case_when(  # ifelse würde auch gehen
    price > mean(price) ~ TRUE,
    TRUE ~ FALSE
  ))
```


```{r}
diamonds %>% 
  count(price_high)
```




d)

```{r}
diamonds %>% 
  select(carat, volume) %>% 
  cor()  #Input: Eine Tabelle mit nur numerischen Spalten
```
















## Log-Transformation


### Problem

a) Betrachten Sie den Zusammenhang von Preis und Gewicht und prüfen Sie, 
ob Sie den Zusammenhang durch eine Log-Transformation *linearisieren* können. 

b) Vielleicht hilft auch eine andere Art von Transformation? Probieren Sie es aus!


### Lösung

Ohne Transformation:

```{r}
diamonds %>% 
  filter(carat < 2.5) %>%  # bleiben >50000 übrig
  ggplot() +
  aes(x = carat, y = price) +
  geom_hex() +
  geom_smooth() +
  geom_smooth(method = "lm", color = "red")
```




```{r}
diamonds %>% 
  filter(carat < 2.5) %>% 
  ggplot() +
  aes(x = carat, y = log(price)) +
  geom_hex() +
  geom_smooth() +
  geom_smooth(method = "lm", color = "red")
```





```{r}
diamonds %>% 
  filter(carat < 2.5) %>% 
  ggplot() +
  aes(x = log(carat), y = log(price)) +
  geom_hex() +
  geom_smooth() +
  geom_smooth(method = "lm", color = "red")
```





```{r}
diamonds %>% 
  filter(carat < 2.5) %>% 
  ggplot() +
  aes(x = carat, y = sqrt(price)) +
  geom_hex() +
  geom_smooth() +
  geom_smooth(method = "lm", color = "red")
```



## Regressionsgüte nach Transformationen

a) Welche Hypothese finden Sie am plausibelsten?
b) Vergleichen Sie die Vorhersagegüte von Modellen, die den Preis anhand des Gewichts vorhersagen.

### Lösung


```{r}
lm1 <- lm(price ~ carat, data = diamonds %>% filter(carat < 2.5))
```

```{r}
plot(lm1)
```


```{r}
summary(lm1)$r.squared
```


```{r}
lm2 <- lm(log(price) ~ carat, data = diamonds %>% filter(carat != 0))
```

```{r}
plot(lm2)
```




```{r}
summary(lm2)$r.squared
```

```{r}
lm3 <- lm(log(price) ~ log(carat), data = diamonds)
```

```{r}
plot(lm3)
```




```{r}
summary(lm3)$r.squared
```


## Fehlende Werte zählen


a) Wie viele fehlenden Werte gibt es in der Tabelle?
b) ... in der Spalte `price`?
c) ... in jeder einzelnen Spalte? 


## Korrelationen mit Preis visualisieren






